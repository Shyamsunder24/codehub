<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coding Profile Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #1a1a2e;
        color: #e0e0e0;
      }
      .gradient-bg {
        background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
      }
      .card {
        background-color: #2a2a44;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 24px;
      }
      .btn {
        padding: 12px 24px;
        border-radius: 9999px;
        font-weight: 600;
        color: white;
        transition: all 0.2s ease-in-out;
      }
      .btn-primary {
        background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      .input-field {
        background-color: #3b3b5c;
        color: #e0e0e0;
        border: 1px solid #4a4a6c;
        border-radius: 8px;
        padding: 12px 16px;
      }
      .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid #fff;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .platform-icon {
        width: 48px;
        height: 48px;
      }
    </style>
  </head>
  <body class="p-6">
    <div id="app" class="max-w-4xl mx-auto">
      <!-- Auth View -->
      <div
        id="auth-view"
        class="max-w-md mx-auto my-12 p-8 card transition-opacity duration-500"
      >
        <h1
          class="text-3xl font-bold mb-4 text-center gradient-bg bg-clip-text text-transparent"
        >
          Login / Register
        </h1>
        <p class="text-sm text-center text-gray-400 mb-6">
          You will now use the backend server for authentication. All data will
          be in-memory for this demo.
        </p>
        <form id="auth-form" class="space-y-4">
          <div>
            <input
              type="text"
              id="auth-username"
              placeholder="Username"
              required
              class="w-full input-field"
            />
          </div>
          <div>
            <input
              type="password"
              id="auth-password"
              placeholder="Password"
              required
              class="w-full input-field"
            />
          </div>
          <button type="submit" class="w-full btn btn-primary">Login</button>
        </form>
        <div class="text-center mt-4 text-sm">
          <a href="#" id="toggle-auth" class="text-blue-400 hover:underline"
            >Don't have an account? Register</a
          >
        </div>
        <div
          id="auth-message"
          class="mt-4 text-center text-red-400 hidden"
        ></div>
      </div>

      <!-- Main App View -->
      <div
        id="main-view"
        class="space-y-8 hidden transition-opacity duration-500"
      >
        <header class="flex justify-between items-center py-4 px-6 card mb-8">
          <h1
            class="text-2xl font-bold gradient-bg bg-clip-text text-transparent"
          >
            Coding Profile Tracker
          </h1>
          <div class="flex items-center space-x-4">
            <span id="user-display" class="text-gray-400 text-sm"></span>
            <button id="logout-btn" class="btn btn-primary px-4 py-2 text-sm">
              Logout
            </button>
          </div>
        </header>

        <!-- Add Profile Section -->
        <div class="card">
          <h2 class="text-xl font-semibold mb-4">Add a Coding Profile</h2>
          <div
            class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4"
          >
            <select id="platform-select" class="flex-1 input-field">
              <option value="leetcode">LeetCode</option>
              <option value="codechef">CodeChef</option>
              <option value="codeforces">Codeforces</option>
              <option value="spoj">SPOJ</option>
              <option value="interviewbit">InterviewBit</option>
            </select>
            <input
              type="text"
              id="username-input"
              placeholder="Enter profile username"
              class="flex-2 input-field"
            />
            <button id="add-profile-btn" class="btn btn-primary">
              Add Profile
            </button>
          </div>
        </div>

        <!-- Your Tracked Profiles Section -->
        <div class="card">
          <h2 class="text-xl font-semibold mb-4">Your Tracked Profiles</h2>
          <div id="profiles-container" class="space-y-4">
            <p id="profiles-loading" class="text-center text-gray-400">
              Loading profiles...
            </p>
            <p id="profiles-error" class="text-center text-red-400 hidden"></p>
            <div id="profile-list" class="space-y-4"></div>
          </div>
        </div>

        <!-- Global Rankings Section -->
        <div class="card">
          <h2 class="text-xl font-semibold mb-4">Global Rankings</h2>
          <p class="text-sm text-gray-400 mb-4">
            This section demonstrates how you could display a real-time global
            ranking by fetching data from the backend.
          </p>
          <div id="rankings-container" class="space-y-4">
            <p id="rankings-loading" class="text-center text-gray-400">
              Loading rankings...
            </p>
            <p id="rankings-error" class="text-center text-red-400 hidden"></p>
            <div id="rankings-list" class="space-y-2"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:3000/api";

      document.addEventListener("DOMContentLoaded", () => {
        const authView = document.getElementById("auth-view");
        const mainView = document.getElementById("main-view");
        const authForm = document.getElementById("auth-form");
        const toggleAuthLink = document.getElementById("toggle-auth");
        const authMessage = document.getElementById("auth-message");
        const logoutBtn = document.getElementById("logout-btn");
        const addProfileBtn = document.getElementById("add-profile-btn");
        const platformSelect = document.getElementById("platform-select");
        const usernameInput = document.getElementById("username-input");
        const profileList = document.getElementById("profile-list");
        const profilesLoading = document.getElementById("profiles-loading");
        const profilesError = document.getElementById("profiles-error");
        const rankingsList = document.getElementById("rankings-list");
        const rankingsLoading = document.getElementById("rankings-loading");
        const rankingsError = document.getElementById("rankings-error");
        const userDisplay = document.getElementById("user-display");

        let isLoginMode = true;
        let currentUserId = localStorage.getItem("userId");

        // --- UI Rendering Functions ---
        const showView = (view) => {
          authView.classList.add("hidden");
          mainView.classList.add("hidden");
          view.classList.remove("hidden");
        };

        const toggleAuthMode = (e) => {
          e.preventDefault();
          isLoginMode = !isLoginMode;
          if (isLoginMode) {
            authForm.querySelector("button").textContent = "Login";
            toggleAuthLink.textContent = "Don't have an account? Register";
          } else {
            authForm.querySelector("button").textContent = "Register";
            toggleAuthLink.textContent = "Already have an account? Login";
          }
          authMessage.textContent = "";
          authMessage.classList.add("hidden");
        };

        const renderProfile = (profile) => {
          const card = document.createElement("div");
          card.classList.add(
            "card",
            "flex",
            "flex-col",
            "sm:flex-row",
            "items-center",
            "space-y-4",
            "sm:space-y-0",
            "sm:space-x-4"
          );
          card.dataset.id = profile.id;

          let statsHtml = "";

          if (profile.data) {
            if (profile.platform.toLowerCase() === "spoj") {
              statsHtml = `
                            <div class="flex-1 text-center">
                                <div class="text-3xl font-bold text-blue-400">${
                                  profile.data.problemsSolved || "N/A"
                                }</div>
                                <div class="text-sm text-gray-400">Problems Solved</div>
                            </div>
                            <div class="flex-1 text-center">
                                <div class="text-3xl font-bold text-blue-400">${
                                  profile.data.contestsAttended || "N/A"
                                }</div>
                                <div class="text-sm text-gray-400">World Rank</div>
                            </div>
                        `;
            } else if (profile.platform.toLowerCase() === "interviewbit") {
              statsHtml = `
                            <div class="flex-1 text-center">
                                <div class="text-3xl font-bold text-blue-400">${
                                  profile.data.problemsSolved || "N/A"
                                }</div>
                                <div class="text-sm text-gray-400">Score</div>
                            </div>
                            <div class="flex-1 text-center">
                                <div class="text-3xl font-bold text-blue-400">${
                                  profile.data.contestRating || "N/A"
                                }</div>
                                <div class="text-sm text-gray-400">Rank</div>
                            </div>
                        `;
            } else {
              statsHtml = `
                            <div class="flex-1 text-center">
                                <div class="text-3xl font-bold text-blue-400">${
                                  profile.data.problemsSolved || "N/A"
                                }</div>
                                <div class="text-sm text-gray-400">Problems Solved</div>
                            </div>
                            <div class="flex-1 text-center">
                                <div class="text-3xl font-bold text-blue-400">${
                                  profile.data.contestsAttended || "N/A"
                                }</div>
                                <div class="text-sm text-gray-400">Contests Attended</div>
                            </div>
                            <div class="flex-1 text-center">
                                <div class="text-3xl font-bold text-blue-400">${
                                  profile.data.contestRating || "N/A"
                                }</div>
                                <div class="text-sm text-gray-400">Contest Rating</div>
                            </div>
                        `;
            }
          } else {
            statsHtml = `
                        <div class="flex-1 text-center">
                            <div class="text-3xl font-bold text-blue-400">--</div>
                            <div class="text-sm text-gray-400">Loading...</div>
                        </div>
                        <div class="flex-1 text-center">
                            <div class="text-3xl font-bold text-blue-400">--</div>
                            <div class="text-sm text-gray-400">Loading...</div>
                        </div>
                        <div class="flex-1 text-center">
                            <div class="text-3xl font-bold text-blue-400">--</div>
                            <div class="text-sm text-gray-400">Loading...</div>
                        </div>
                    `;
          }

          card.innerHTML = `
                    <div class="flex-shrink-0 w-full sm:w-auto text-center sm:text-left">
                        <div class="text-xl font-semibold">${profile.platform}</div>
                        <div class="text-sm text-gray-400">Username: ${profile.username}</div>
                    </div>
                    <div class="flex-1 flex w-full space-x-4">
                        ${statsHtml}
                    </div>
                    <button class="flex-shrink-0 text-red-400 hover:text-red-500 delete-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
          profileList.appendChild(card);
        };

        const renderRankings = (rankings) => {
          rankingsList.innerHTML = "";
          rankings.forEach((ranking, index) => {
            const item = document.createElement("div");
            item.classList.add(
              "flex",
              "justify-between",
              "items-center",
              "p-4",
              "rounded-lg",
              "bg-gray-700"
            );
            item.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <span class="font-bold text-xl">${index + 1}.</span>
                            <span>${ranking.username}</span>
                        </div>
                        <div class="text-sm text-gray-400">
                            Solved: ${ranking.totalProblemsSolved}
                        </div>
                        <div class="text-sm text-gray-400">
                            Rating: ${ranking.averageContestRating}
                        </div>
                    `;
            rankingsList.appendChild(item);
          });
        };

        // --- Data Fetching and Event Handlers ---
        const fetchProfiles = async (userId) => {
          profilesLoading.classList.remove("hidden");
          profilesError.classList.add("hidden");
          profileList.innerHTML = "";
          try {
            const response = await fetch(`${API_BASE_URL}/profiles/${userId}`);
            if (!response.ok) {
              throw new Error("Failed to fetch profiles.");
            }
            const profiles = await response.json();
            if (profiles.length === 0) {
              profileList.innerHTML = `<p class="text-center text-gray-400">No profiles added yet.</p>`;
            } else {
              profiles.forEach(renderProfile);
            }
          } catch (error) {
            profilesError.textContent =
              "Failed to load data. Please ensure your backend server is running and accessible.";
            profilesError.classList.remove("hidden");
          } finally {
            profilesLoading.classList.add("hidden");
          }
        };

        const fetchRankings = async () => {
          rankingsLoading.classList.remove("hidden");
          rankingsError.classList.add("hidden");
          try {
            const response = await fetch(`${API_BASE_URL}/rankings`);
            if (!response.ok) {
              throw new Error("Failed to fetch rankings.");
            }
            const rankings = await response.json();
            renderRankings(rankings);
          } catch (error) {
            rankingsError.textContent = "Failed to load rankings.";
            rankingsError.classList.remove("hidden");
          } finally {
            rankingsLoading.classList.add("hidden");
          }
        };

        const checkLoginState = () => {
          if (currentUserId) {
            showView(mainView);
            userDisplay.textContent = `User: ${currentUserId}`;
            fetchProfiles(currentUserId);
            fetchRankings();
          } else {
            showView(authView);
          }
        };

        authForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const username = document.getElementById("auth-username").value;
          const password = document.getElementById("auth-password").value;
          const endpoint = isLoginMode ? "login" : "register";

          try {
            const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, password }),
            });

            const result = await response.json();
            if (response.ok) {
              localStorage.setItem("userId", result.userId);
              currentUserId = result.userId;
              checkLoginState();
            } else {
              authMessage.textContent = result.message;
              authMessage.classList.remove("hidden");
            }
          } catch (error) {
            authMessage.textContent =
              "Could not connect to the server. Please ensure the backend is running.";
            authMessage.classList.remove("hidden");
          }
        });

        logoutBtn.addEventListener("click", () => {
          localStorage.removeItem("userId");
          currentUserId = null;
          showView(authView);
        });

        addProfileBtn.addEventListener("click", async () => {
          const platform = platformSelect.value;
          const username = usernameInput.value.trim();

          if (!username) {
            alert("Please enter a username.");
            return;
          }

          try {
            const response = await fetch(`${API_BASE_URL}/profiles`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                userId: currentUserId,
                platform,
                username,
              }),
            });
            if (!response.ok) {
              throw new Error("Failed to add profile.");
            }
            usernameInput.value = "";
            fetchProfiles(currentUserId);
          } catch (error) {
            profilesError.textContent =
              "Failed to add profile. Please check the username and try again.";
            profilesError.classList.remove("hidden");
          }
        });

        profileList.addEventListener("click", async (e) => {
          if (e.target.closest(".delete-btn")) {
            const card = e.target.closest(".card");
            const profileId = card.dataset.id;
            try {
              const response = await fetch(
                `${API_BASE_URL}/profiles/${currentUserId}/${profileId}`,
                {
                  method: "DELETE",
                }
              );
              if (!response.ok) {
                throw new Error("Failed to delete profile.");
              }
              fetchProfiles(currentUserId);
            } catch (error) {
              profilesError.textContent = "Failed to delete profile.";
              profilesError.classList.remove("hidden");
            }
          }
        });

        toggleAuthLink.addEventListener("click", toggleAuthMode);

        // Initial check to determine which view to show
        checkLoginState();
      });
    </script>
  </body>
</html>
